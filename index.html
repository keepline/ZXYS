<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BUDGET.OS v1.7</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 引入科幻字体 Orbitron -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* 核心变量 */
            --bg-base: #0a0a0c;
            --card-base-r: 20; --card-base-g: 20; --card-base-b: 25;
            --accent: #00f2ff; /* 赛博青 */
            --accent-secondary: #ff0055; /* 赛博红 */
            
            /* 玻璃与光效 */
            --glass-bg: rgba(var(--card-base-r), var(--card-base-g), var(--card-base-b), 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #f0f0f0;
            --text-muted: #666;
            --input-bg: rgba(0, 0, 0, 0.5);
            
            --ease-expo: cubic-bezier(0.19, 1, 0.22, 1);
        }

        body {
            font-family: 'Montserrat', -apple-system, "Microsoft YaHei", sans-serif;
            background-color: var(--bg-base);
            /* 深邃宇宙背景 */
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(0, 242, 255, 0.08) 0%, transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(255, 0, 85, 0.08) 0%, transparent 25%);
            color: var(--text-main);
            margin: 0; padding: 20px; 
            padding-bottom: calc(120px + env(safe-area-inset-bottom));
            overflow-x: hidden;
        }

        /* SVG Icons */
        .icon { width: 16px; height: 16px; fill: currentColor; vertical-align: text-bottom; margin-right: 4px; }
        .icon-lg { width: 24px; height: 24px; margin: 0; }

        /* 通用玻璃卡片 */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 24px;
            padding: 24px; margin-bottom: 25px;
            box-shadow: 0 20px 50px -10px rgba(0,0,0,0.6);
            position: relative; overflow: hidden;
        }
        /* 卡片顶部的微光条 */
        .glass-card::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        }

        /* --- 头部 LOGO 设计 (核心修改) --- */
        .header-box { text-align: center; margin-bottom: 40px; margin-top: 20px; position: relative; z-index: 10; }
        
        .cyber-logo {
            font-family: 'Orbitron', sans-serif; /* 科幻字体 */
            font-weight: 900;
            font-size: 2.2rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            position: relative;
            display: inline-block;
            
            /* 渐变文字遮罩 */
            background: linear-gradient(135deg, #fff 30%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            
            /* 荧光阴影 */
            filter: drop-shadow(0 0 15px rgba(0, 242, 255, 0.3));
        }
        
        .version-tag {
            font-family: 'Orbitron', sans-serif; font-size: 0.6rem; 
            color: var(--accent-secondary); border: 1px solid var(--accent-secondary);
            padding: 2px 6px; border-radius: 4px; position: absolute; top: -5px; right: -25px;
            box-shadow: 0 0 10px var(--accent-secondary);
        }

        /* Config Bar */
        .config-bar { display: flex; justify-content: center; gap: 15px; margin-top: 15px; }
        .btn-config { 
            background: rgba(255,255,255,0.03); color: #888; border: 1px solid var(--glass-border);
            padding: 8px 16px; font-size: 0.7rem; border-radius: 20px; font-weight: 600;
            display: flex; align-items: center; transition: all 0.3s; 
        }
        .btn-config:active { background: rgba(255,255,255,0.1); color: #fff; }
        .status-dot { height: 6px; width: 6px; border-radius: 50%; display: inline-block; background: #333; margin-right: 8px; }
        .status-dot.online { background: #00ff88; box-shadow: 0 0 8px #00ff88; }
        .status-dot.syncing { background: #ffd700; animation: blink 0.5s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }

        /* --- 视觉模块 (Avant-Garde Chart) --- */
        .visual-module { display: flex; flex-wrap: wrap; gap: 30px; }
        
        /* 1. 图表容器：增加中心文字 */
        .chart-box { 
            flex: 1; min-width: 280px; height: 320px; position: relative; 
            display: flex; justify-content: center; align-items: center; 
        }
        /* 2. 这里的 Canvas 增加滤镜，制造光晕 */
        #budgetChart { 
            filter: drop-shadow(0 0 10px rgba(0, 242, 255, 0.2)); 
            z-index: 2;
        }
        /* 3. 中心文字覆盖层 */
        .chart-center-text {
            position: absolute; text-align: center; z-index: 1; pointer-events: none;
        }
        .chart-center-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px; display: block; margin-bottom: 5px; }
        .chart-center-value { font-family: 'Orbitron', sans-serif; font-size: 1.8rem; font-weight: 700; color: #fff; text-shadow: 0 0 20px rgba(255,255,255,0.3); }

        .stats-bars { flex: 1; min-width: 280px; display: flex; flex-direction: column; justify-content: center; }
        .progress-group { margin-bottom: 20px; }
        .progress-labels { display: flex; justify-content: space-between; font-size: 0.8em; color: var(--text-muted); margin-bottom: 8px; font-weight: 500; }
        .progress-track { background: rgba(255,255,255,0.05); height: 4px; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 2px; transition: width 1s var(--ease-expo); position: relative; box-shadow: 0 0 15px currentColor; }

        .total-summary { 
            display: flex; justify-content: space-around; margin-top: 20px; padding-top: 20px; 
            border-top: 1px solid var(--glass-border); gap: 10px;
        }
        .summary-item { text-align: center; flex: 1; }
        .summary-label { font-size: 0.7rem; color: var(--text-muted); margin-bottom: 5px; display: block; letter-spacing: 1px; }
        .money { font-size: 1.1em; font-weight: 700; color: #fff; font-family: 'Montserrat', sans-serif;}

        /* --- 输入与表格 --- */
        input, select { 
            background: var(--input-bg); border: 1px solid var(--glass-border); color: #fff; 
            padding: 14px; border-radius: 12px; width: 100%; box-sizing: border-box;
            font-size: 0.9rem; transition: all 0.3s; font-family: 'Montserrat', "Microsoft YaHei", sans-serif;
            font-weight: 500;
        }
        input:focus { border-color: var(--accent); background: rgba(0,0,0,0.8); outline: none; box-shadow: 0 0 15px rgba(0, 242, 255, 0.2); }

        .input-area { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 12px; margin-bottom: 25px; }
        .btn-add { 
            background: linear-gradient(135deg, var(--accent), #00aaff); 
            color: #000; border: none; padding: 16px; grid-column: 1 / -1; 
            border-radius: 12px; font-weight: 800; font-size: 0.9rem; cursor: pointer;
            box-shadow: 0 5px 20px -5px rgba(0, 242, 255, 0.5); 
            display: flex; align-items: center; justify-content: center; gap: 8px;
            letter-spacing: 1px; transition: all 0.2s;
        }
        .btn-add:active { transform: scale(0.98); }

        /* PC Table */
        .table-view { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 10px; }
        .table-view th { 
            text-align: left; padding: 15px; color: var(--text-muted); border-bottom: 1px solid var(--glass-border); 
            cursor: pointer; font-size: 0.85rem; font-weight: 700;
        }
        .table-view td { padding: 15px 10px; border-bottom: 1px solid rgba(255,255,255,0.02); vertical-align: middle; }
        .table-view input { border: none; background: transparent; padding: 0; font-family: 'Consolas', monospace; }
        .type-swatch { width: 6px; height: 12px; border-radius: 2px; display: inline-block; margin-right: 10px; vertical-align: middle; box-shadow: 0 0 10px currentColor; }

        /* Mobile Swipe Cards */
        .card-list-view { display: none; flex-direction: column; gap: 20px; }
        .swipe-wrapper { position: relative; overflow: hidden; border-radius: 16px; }
        .swipe-action-bg {
            position: absolute; top: 0; bottom: 0; right: 0; width: 80px; 
            background: rgba(255, 68, 68, 0.2); border-left: 1px solid rgba(255, 68, 68, 0.3);
            display: flex; align-items: center; justify-content: center; z-index: 1;
        }
        .btn-swipe-delete { background: transparent; border: none; color: #ff6666; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; }

        .item-card { 
            background: rgba(20, 20, 25, 0.8); 
            border: 1px solid var(--glass-border); border-radius: 16px; padding: 20px; 
            position: relative; z-index: 2; transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            will-change: transform;
        }
        /* 左侧光条 */
        .item-card::before { content: ''; position: absolute; top: 0; left: 0; bottom: 0; width: 3px; background: var(--item-color, #888); box-shadow: 0 0 10px var(--item-color); }
        
        .item-header { display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: 700; font-size: 1.1em; padding-left: 10px; align-items: center; }
        .type-badge { font-weight: 600; font-size: 0.6em; background: rgba(255,255,255,0.05); padding: 4px 8px; border-radius: 4px; margin-left: 8px; color: #ccc; letter-spacing: 0.5px;}
        .item-body { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding-left: 10px; }
        .field-label { font-size: 0.75em; color: var(--text-muted); margin-bottom: 6px; display: block; }
        .field-input { background: transparent; border: none; border-bottom: 1px solid rgba(255,255,255,0.1); border-radius: 0; padding: 4px 0; font-family: 'Consolas', monospace; font-size: 1.1em; color: #fff; }

        /* Floating Buttons */
        .fab-container { position: fixed; bottom: calc(30px + env(safe-area-inset-bottom)); right: 25px; display: flex; flex-direction: column; gap: 15px; z-index: 9999; }
        .fab {
            width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            border: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); color: #fff; backdrop-filter: blur(10px); background: rgba(30,30,30,0.8);
        }
        .fab:active { transform: scale(0.9); }
        .fab-save { background: var(--accent); color: #000; border: none; box-shadow: 0 0 25px var(--accent); }

        /* Modal & Theme Panel (Same as v1.6 but styled) */
        .theme-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(5px); }
        .theme-overlay.active { opacity: 1; pointer-events: auto; }
        .theme-panel { position: fixed; top: 0; right: -400px; width: 340px; height: 100%; background: #0f0f12; border-left: 1px solid #333; z-index: 10001; transition: transform 0.4s var(--ease-expo); padding: 30px; box-sizing: border-box; display: flex; flex-direction: column; overflow-y: auto; }
        .theme-overlay.active .theme-panel { transform: translateX(-400px); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal-content { background: #151518; padding: 40px; border-radius: 24px; width: 85%; max-width: 350px; border: 1px solid var(--glass-border); display: flex; flex-direction: column; gap: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }

        /* Color Picker Styles */
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        .panel-title { font-family: 'Orbitron', sans-serif; font-size: 1.2rem; font-weight: 700; color: #fff; }
        .color-section { margin-bottom: 30px; }
        .section-label { font-size: 0.7rem; color: var(--accent); margin-bottom: 15px; font-weight: 700; letter-spacing: 1px; }
        .swatch-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .swatch-row { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.03); padding: 10px 15px; border-radius: 12px; }
        .color-planet-wrapper { position: relative; width: 28px; height: 28px; border-radius: 50%; overflow: hidden; cursor: pointer; }
        .planet-face { width: 100%; height: 100%; border-radius: 50%; box-shadow: 0 0 10px currentColor; border: 2px solid rgba(255,255,255,0.2); }
        .color-planet-wrapper input { position: absolute; top:-10px; left:-10px; width:50px; height:50px; opacity: 0; cursor: pointer; }
        .btn-reset { margin-top: auto; padding: 15px; background: rgba(255,255,255,0.05); border: 1px solid #333; color: #888; border-radius: 12px; cursor: pointer; }

        @media screen and (max-width: 768px) {
            .table-view { display: none; } .card-list-view { display: flex; }
            .input-area { grid-template-columns: 1fr 1fr; }
            .input-area input:nth-child(1), .input-area input:nth-child(2) { grid-column: span 2; }
            .header-box { flex-direction: column; gap: 15px; }
            .config-bar { width: 100%; }
            .theme-overlay.active .theme-panel { transform: translateY(0); }
            .theme-panel { top: auto; bottom: 0; right: 0; width: 100%; height: 75vh; transform: translateY(100%); border-left: none; border-top: 1px solid rgba(255,255,255,0.2); border-radius: 30px 30px 0 0; }
        }
    </style>
</head>
<body>
    <svg style="display: none;">
        <symbol id="icon-settings" viewBox="0 0 24 24"><path d="M12,1L3,5v6c0,5.55,3.84,10.74,9,12c5.16-1.26,9-6.45,9-12V5L12,1z M12,11.99h7c-0.53,4.12-3.28,7.79-7,8.94V12H5V6.3l7-3.11V11.99z"/></symbol>
        <symbol id="icon-refresh" viewBox="0 0 24 24"><path d="M17.65,6.35C16.2,4.9,14.21,4,12,4c-4.42,0-7.99,3.58-7.99,8s3.57,8,7.99,8c3.73,0,6.84-2.55,7.73-6h-2.08 c-0.82,2.33-3.04,4-5.65,4c-3.31,0-6-2.69-6-6s2.69-6,6-6c1.66,0,3.14,0.69,4.22,1.78L13,11h7V4L17.65,6.35z"/></symbol>
        <symbol id="icon-save" viewBox="0 0 24 24"><path d="M17,3H5C3.89,3,3,3.9,3,5v14c0,1.1,0.89,2,2,2h14c1.1,0,2-0.9,2-2V7L17,3z M12,19c-1.66,0-3-1.34-3-3s1.34-3,3-3 s3,1.34,3,3S13.66,19,12,19z M15,9H5V5h10V9z"/></symbol>
        <symbol id="icon-plus" viewBox="0 0 24 24"><path d="M19,13h-6v6h-2v-6H5v-2h6V5h2v6h6V13z"/></symbol>
        <symbol id="icon-trash" viewBox="0 0 24 24"><path d="M6,19c0,1.1,0.9,2,2,2h8c1.1,0,2-0.9,2-2V7H6V19z M19,4h-3.5l-1-1h-5l-1,1H5v2h14V4z"/></symbol>
        <symbol id="icon-palette" viewBox="0 0 24 24"><path d="M12,3a9,9,0,0,0,0,18c0.83,0,1.5-0.67,1.5-1.5c0-0.39-0.15-0.74-0.39-1.01c-0.23-0.26-0.38-0.61-0.38-0.99 c0-0.83,0.67-1.5,1.5-1.5H16c2.76,0,5-2.24,5-5C21,5.24,16.97,3,12,3z M6.5,12c-0.83,0-1.5-0.67-1.5-1.5S5.67,9,6.5,9 S8,9.67,8,10.5S7.33,12,6.5,12z M9.5,8C8.67,8,8,7.33,8,6.5S8.67,5,9.5,5S11,5.67,11,6.5S10.33,8,9.5,8z M14.5,8 c-0.83,0-1.5-0.67-1.5-1.5S13.67,5,14.5,5S16,5.67,16,6.5S15.33,8,14.5,8z"/></symbol>
        <symbol id="icon-close" viewBox="0 0 24 24"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41z"/></symbol>
    </svg>

    <div id="configModal" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--accent); margin:0;">连接 GitHub</h3>
            <input type="password" id="cfgToken" placeholder="GitHub Token">
            <input type="text" id="cfgUser" placeholder="用户名">
            <input type="text" id="cfgRepo" placeholder="仓库名">
            <input type="text" id="cfgPath" placeholder="文件名 (budget_data.json)" value="budget_data.json">
            <button onclick="saveConfig()" class="btn-add">连接</button>
            <button onclick="closeModal('configModal')" style="background:transparent; color:#666; border:none; cursor:pointer;">取消</button>
        </div>
    </div>

    <div id="themeOverlay" class="theme-overlay">
        <div class="theme-panel">
            <div class="panel-header">
                <div class="panel-title">Studio</div>
                <button onclick="toggleThemePanel(false)" style="background:none; border:none; color:#fff;"><svg class="icon-lg"><use href="#icon-close"></use></svg></button>
            </div>
            <div class="color-section">
                <div class="section-label">System</div>
                <div class="swatch-grid">
                    <div class="swatch-row"><span class="swatch-label">Background</span><div class="color-planet-wrapper"><div class="planet-face" id="face-bg"></div><input type="color" id="pickerBg" onchange="updateTheme('bg', this.value)"></div></div>
                    <div class="swatch-row"><span class="swatch-label">Glass</span><div class="color-planet-wrapper"><div class="planet-face" id="face-card"></div><input type="color" id="pickerCard" onchange="updateTheme('card', this.value)"></div></div>
                    <div class="swatch-row"><span class="swatch-label">Accent</span><div class="color-planet-wrapper"><div class="planet-face" id="face-accent"></div><input type="color" id="pickerAccent" onchange="updateTheme('accent', this.value)"></div></div>
                </div>
            </div>
            <div class="color-section">
                <div class="section-label">Categories</div>
                <div id="typeColorList" class="swatch-grid" style="display:grid; gap:10px;"></div>
            </div>
            <button onclick="resetTheme()" class="btn-reset">Reset Defaults</button>
        </div>
    </div>

    <div class="container">
        <div class="header-box">
            <!-- 赛博朋克 LOGO -->
            <div class="cyber-logo">
                BUDGET.OS <span class="version-tag">v1.7</span>
            </div>
            
            <div class="config-bar">
                <div style="display:flex; align-items:center;">
                    <span id="statusDot" class="status-dot"></span>
                    <span id="statusText" style="font-size:0.75rem; color:#888;">READY</span>
                </div>
                <button class="btn-config" onclick="openModal('configModal')"><svg class="icon"><use href="#icon-settings"></use></svg></button>
                <button class="btn-config" onclick="syncData(true)"><svg class="icon"><use href="#icon-refresh"></use></svg></button>
            </div>
        </div>

        <div class="glass-card visual-module">
            <div class="chart-box">
                <!-- 中心文字 -->
                <div class="chart-center-text">
                    <span class="chart-center-label">Total</span>
                    <span id="centerTotal" class="chart-center-value">0</span>
                </div>
                <canvas id="budgetChart"></canvas>
            </div>
            
            <div class="stats-bars" id="progressBarContainer"></div>
            
            <div class="total-summary">
                <div class="summary-item"><span class="summary-label">已支付</span><span id="txtPaid" class="money" style="color:#00ff88;">0</span></div>
                <div class="summary-item"><span class="summary-label">剩余</span><span id="txtRemain" class="money" style="color:#888;">0</span></div>
            </div>
        </div>

        <div class="glass-card">
            <h2 style="margin-top:0; font-weight:800; font-size:1rem; color:var(--accent); border-bottom:1px solid var(--glass-border); padding-bottom:15px; margin-bottom:20px; letter-spacing:1px;">支出明细表</h2>
            <div class="input-area">
                <input type="text" id="inType" placeholder="类型 (如: 硬装)" list="typeList">
                <datalist id="typeList">
                    <option value="硬装"><option value="软装"><option value="土建"><option value="设备"><option value="设计">
                </datalist>
                <input type="text" id="inName" placeholder="项目名称">
                <input type="number" id="inTotal" placeholder="总金额">
                <input type="number" id="inDeposit" placeholder="定金">
                <input type="number" id="inSecond" placeholder="次付">
                <input type="number" id="inFinal" placeholder="尾款">
                <button class="btn-add" onclick="addNewItem()"><svg class="icon"><use href="#icon-plus"></use></svg> 添加项目</button>
            </div>

            <table class="table-view" id="pcTable">
                <thead>
                    <tr>
                        <th onclick="sortData('type')">类型 ↕</th>
                        <th onclick="sortData('name')">名称 ↕</th>
                        <th onclick="sortData('total')">总金额 ↕</th>
                        <th>定金</th>
                        <th>次付</th>
                        <th>尾款</th>
                        <th style="text-align:right">操作</th>
                    </tr>
                </thead>
                <tbody id="pcTableBody"></tbody>
            </table>

            <div class="card-list-view" id="mobileList"></div>
        </div>
    </div>

    <div class="fab-container">
        <button class="fab fab-theme" onclick="toggleThemePanel(true)"><svg class="icon-lg"><use href="#icon-palette"></use></svg></button>
        <button class="fab fab-save" onclick="syncData()"><svg class="icon-lg" style="fill:#000;"><use href="#icon-save"></use></svg></button>
    </div>

    <script>
        // --- 逻辑部分保持 v1.6 核心，增加图表优化 ---
        let expenses = [];
        let githubConfig = JSON.parse(localStorage.getItem('gh_config')) || null;
        let fileSha = null;
        let myChart = null;
        const DEFAULT_PALETTE = ['#00f2ff', '#ff0055', '#ffe600', '#b900ff', '#ff8800', '#00ff99'];
        let typeColorMap = JSON.parse(localStorage.getItem('type_colors')) || {};

        window.onload = function() {
            initTheme(); 
            if (!githubConfig) {
                setStatus('offline', 'OFFLINE');
                setTimeout(() => openModal('configModal'), 1000);
                loadLocal();
            } else {
                syncData(true);
            }
        };

        // Swipe Logic
        let touchStartX = 0; let activeSwipeEl = null;
        function handleTouchStart(e) { touchStartX = e.touches[0].clientX; if(activeSwipeEl && activeSwipeEl !== e.currentTarget) { activeSwipeEl.style.transform = 'translateX(0)'; activeSwipeEl = null; } }
        function handleTouchMove(e) { const diff = e.touches[0].clientX - touchStartX; if(diff < 0 && diff > -100) e.currentTarget.style.transform = `translateX(${diff}px)`; }
        function handleTouchEnd(e) { const diff = e.changedTouches[0].clientX - touchStartX; if(diff < -50) { e.currentTarget.style.transform = 'translateX(-80px)'; activeSwipeEl = e.currentTarget; } else { e.currentTarget.style.transform = 'translateX(0)'; activeSwipeEl = null; } }

        function getTypeColor(type) { if (typeColorMap[type]) return typeColorMap[type]; const c = DEFAULT_PALETTE[Object.keys(typeColorMap).length % DEFAULT_PALETTE.length]; typeColorMap[type]=c; localStorage.setItem('type_colors',JSON.stringify(typeColorMap)); return c; }
        function setTypeColor(type, color) { typeColorMap[type]=color; localStorage.setItem('type_colors',JSON.stringify(typeColorMap)); renderUI(); updatePlanetFace(`face-${type}`, color); }
        function toggleThemePanel(show) { document.getElementById('themeOverlay').classList.toggle('active', show); if(show) renderThemeModalDynamic(); }
        
        function renderThemeModalDynamic() {
            const container = document.getElementById('typeColorList'); container.innerHTML = '';
            [...new Set(expenses.map(e => e.type))].sort().forEach(type => {
                const color = getTypeColor(type);
                const row = document.createElement('div'); row.className = 'swatch-row';
                row.innerHTML = `<span class="swatch-label">${type}</span><div class="color-planet-wrapper"><div class="planet-face" id="face-${type}" style="background:${color}; color:${color}"></div><input type="color" value="${color}" onchange="setTypeColor('${type}', this.value)"></div>`;
                container.appendChild(row);
            });
        }
        function updatePlanetFace(id, color) { const el = document.getElementById(id); if(el) { el.style.background = color; el.style.color = color; } }
        
        // Theme
        function initTheme() {
            const theme = JSON.parse(localStorage.getItem('user_theme')) || {};
            if(theme.bg) applyThemeVar('--bg-base', theme.bg);
            if(theme.accent) applyThemeVar('--accent', theme.accent);
            if(theme.card) updateCardTint(theme.card);
            updatePlanetFace('face-bg', theme.bg || '#0a0a0c');
            updatePlanetFace('face-card', theme.card || '#141419');
            updatePlanetFace('face-accent', theme.accent || '#00f2ff');
            if(theme.bg) document.getElementById('pickerBg').value = theme.bg;
            if(theme.accent) document.getElementById('pickerAccent').value = theme.accent;
        }
        function updateTheme(type, val) {
            const theme = JSON.parse(localStorage.getItem('user_theme')) || {};
            if(type === 'bg') { applyThemeVar('--bg-base', val); theme.bg = val; updatePlanetFace('face-bg', val); }
            if(type === 'accent') { applyThemeVar('--accent', val); theme.accent = val; updatePlanetFace('face-accent', val); }
            if(type === 'card') { updateCardTint(val); theme.card = val; updatePlanetFace('face-card', val); }
            localStorage.setItem('user_theme', JSON.stringify(theme));
        }
        function updateCardTint(hex) { const r = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); if(r) { document.documentElement.style.setProperty('--card-base-r', parseInt(r[1],16)); document.documentElement.style.setProperty('--card-base-g', parseInt(r[2],16)); document.documentElement.style.setProperty('--card-base-b', parseInt(r[3],16)); } }
        function applyThemeVar(n, v) { document.documentElement.style.setProperty(n, v); }
        function resetTheme() { localStorage.removeItem('user_theme'); localStorage.removeItem('type_colors'); location.reload(); }

        // Data
        async function syncData(forcePull = false) {
            if (!githubConfig) { renderUI(); return; }
            setStatus('syncing', 'SYNC');
            const { token, user, repo, path } = githubConfig;
            const url = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;
            try {
                if (forcePull) {
                    const res = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
                    if (res.status === 200) {
                        const data = await res.json(); fileSha = data.sha;
                        expenses = JSON.parse(decodeURIComponent(escape(window.atob(data.content))));
                    }
                } else {
                    const content = btoa(unescape(encodeURIComponent(JSON.stringify(expenses, null, 2))));
                    const body = { message: `Update v1.7`, content: content };
                    if (fileSha) body.sha = fileSha;
                    const res = await fetch(url, { method: 'PUT', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                    if (res.ok) fileSha = (await res.json()).content.sha;
                }
                setStatus('online', 'OK'); localStorage.setItem('local_backup', JSON.stringify(expenses)); renderUI();
            } catch (e) { console.error(e); setStatus('offline', 'ERR'); loadLocal(); }
        }
        function loadLocal() { expenses = JSON.parse(localStorage.getItem('local_backup')) || []; renderUI(); }
        function renderUI() { renderPC(); renderMobile(); renderCharts(); }

        function renderPC() {
            const tbody = document.getElementById('pcTableBody'); tbody.innerHTML = '';
            expenses.forEach((item, index) => {
                const color = getTypeColor(item.type);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="display:flex; align-items:center;"><span class="type-swatch" style="background:${color}; box-shadow:0 0 8px ${color}"></span><input value="${item.type}" onchange="upd(${index}, 'type', this.value)" style="flex:1;"></td>
                    <td><input value="${item.name}" onchange="upd(${index}, 'name', this.value)"></td>
                    <td><input type="number" value="${item.total}" onchange="upd(${index}, 'total', this.value)"></td>
                    <td><input type="number" value="${item.deposit}" onchange="upd(${index}, 'deposit', this.value)"></td>
                    <td><input type="number" value="${item.second}" onchange="upd(${index}, 'second', this.value)"></td>
                    <td><input type="number" value="${item.final}" onchange="upd(${index}, 'final', this.value)"></td>
                    <td style="text-align:right"><button onclick="del(${index})" style="background:none; border:none; color:#666; cursor:pointer;"><svg class="icon"><use href="#icon-trash"></use></svg></button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderMobile() {
            const container = document.getElementById('mobileList'); container.innerHTML = '';
            expenses.forEach((item, index) => {
                const color = getTypeColor(item.type);
                const paid = (parseFloat(item.deposit)||0) + (parseFloat(item.second)||0) + (parseFloat(item.final)||0);
                const progress = item.total > 0 ? Math.round(paid / item.total * 100) : 0;
                
                const wrapper = document.createElement('div'); wrapper.className = 'swipe-wrapper';
                wrapper.innerHTML = `
                    <div class="swipe-action-bg"><button class="btn-swipe-delete" onclick="del(${index})"><svg class="icon-lg"><use href="#icon-trash"></use></svg></button></div>
                    <div class="item-card" style="--item-color:${color}" ontouchstart="handleTouchStart(event)" ontouchmove="handleTouchMove(event)" ontouchend="handleTouchEnd(event)">
                        <div class="item-header"><div>${item.name} <span class="type-badge" style="color:${color}; border:1px solid ${color}">${item.type}</span></div><span style="color:${progress>=100?'#00ff88':'#888'}; font-size:0.9em;">${progress}%</span></div>
                        <div class="item-body">
                            <div><span class="field-label">总金额</span><input class="field-input" type="number" value="${item.total}" onchange="upd(${index}, 'total', this.value)" style="color:var(--accent)"></div>
                            <div><span class="field-label">定金</span><input class="field-input" type="number" value="${item.deposit}" onchange="upd(${index}, 'deposit', this.value)"></div>
                            <div><span class="field-label">次付</span><input class="field-input" type="number" value="${item.second}" onchange="upd(${index}, 'second', this.value)"></div>
                            <div><span class="field-label">尾款</span><input class="field-input" type="number" value="${item.final}" onchange="upd(${index}, 'final', this.value)"></div>
                        </div>
                    </div>`;
                container.appendChild(wrapper);
            });
        }

        function renderCharts() {
            let total = 0, paid = 0; const stats = {};
            expenses.forEach(item => {
                const t = parseFloat(item.total) || 0;
                const p = (parseFloat(item.deposit)||0) + (parseFloat(item.second)||0) + (parseFloat(item.final)||0);
                total += t; paid += p;
                if(!stats[item.type]) stats[item.type] = 0; stats[item.type] += t;
            });
            
            // Update Center Text
            document.getElementById('centerTotal').innerText = total > 10000 ? (total/10000).toFixed(1) + 'w' : total.toLocaleString();
            document.getElementById('txtPaid').innerText = paid.toLocaleString();
            document.getElementById('txtRemain').innerText = (total - paid).toLocaleString();

            const ctx = document.getElementById('budgetChart').getContext('2d');
            const labels = Object.keys(stats);
            const data = labels.map(k => stats[k]);
            const bgColors = labels.map(type => getTypeColor(type));

            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: labels, datasets: [{ data: data, backgroundColor: bgColors, borderWidth: 0, hoverOffset: 10, borderRadius: 20, spacing: 5 }] },
                options: { 
                    maintainAspectRatio: false, 
                    cutout: '85%', // Thin Ring
                    layout: { padding: 20 }, 
                    plugins: { legend: { display: false } } // Hide default legend for cleaner look
                }
            });

            const barCont = document.getElementById('progressBarContainer'); barCont.innerHTML = '';
            const totalPct = total > 0 ? (paid/total*100) : 0;
            addBar(barCont, '总支付进度', totalPct, '#00ff88');
            labels.forEach(type => {
                const pct = total > 0 ? (stats[type] / total * 100) : 0;
                addBar(barCont, type, pct, getTypeColor(type));
            });
        }
        function addBar(container, label, pct, color) {
            const div = document.createElement('div'); div.className = 'progress-group';
            div.innerHTML = `<div class="progress-labels"><span>${label}</span><span>${pct.toFixed(1)}%</span></div><div class="progress-track"><div class="progress-fill" style="width:${pct}%; background:${color}; box-shadow: 0 0 10px ${color}"></div></div>`;
            container.appendChild(div);
        }

        function upd(i, k, v) { expenses[i][k] = v; renderCharts(); syncData(); }
        function del(i) { if(confirm('删除此项?')) { expenses.splice(i, 1); syncData(); } }
        function addNewItem() { expenses.push({ type: document.getElementById('inType').value||'其他', name: document.getElementById('inName').value||'项目', total: document.getElementById('inTotal').value||0, deposit:0, second:0, final:0 }); ['inName','inTotal','inDeposit','inSecond','inFinal'].forEach(id=>document.getElementById(id).value=''); syncData(); }
        function sortData(k) { expenses.sort((a,b)=>(a[k]>b[k]?1:-1)); renderUI(); }
        function openModal(id) { document.getElementById(id).style.display='flex'; }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function saveConfig() { githubConfig = { token: document.getElementById('cfgToken').value, user: document.getElementById('cfgUser').value, repo: document.getElementById('cfgRepo').value, path: document.getElementById('cfgPath').value }; localStorage.setItem('gh_config', JSON.stringify(githubConfig)); closeModal('configModal'); syncData(true); }
        function setStatus(cls, txt) { document.getElementById('statusDot').className = `status-dot ${cls}`; document.getElementById('statusText').innerText = txt; }
    </script>
</body>
</html>
